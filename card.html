<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Mali&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: 'Mali', cursive;
            background: linear-gradient(to right, #FFC2D1, #FFFFFF, #FFC2D1);
            color: #5C3A42;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .container {
            width: min(980px, 96vw);
        }

        header {
            text-align: center;
            margin-bottom: 14px;
        }

        h1 {
            font-size: 28px;
        }

        .grid {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        }

        .card {
            background: #fff;
            border: 2px solid #E86C8D;
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, .08);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform .12s ease, box-shadow .12s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 30px rgba(0, 0, 0, .12);
        }

        .title {
            font-weight: 700;
        }

        .pill {
            font-size: 12px;
            background: #fff0f4;
            border: 1px solid #f4b4c6;
            padding: 6px 10px;
            border-radius: 999px;
            display: inline-block;
        }

        .actions {
            margin-top: auto;
            display: flex;
            gap: 8px;
        }

        .btn {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 999px;
            background: #E86C8D;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 8px 18px rgba(232, 108, 141, .3);
            transition: transform .06s ease, filter .15s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            filter: brightness(.97);
        }

        .ghost {
            background: transparent;
            color: #5C3A42;
            border: 1.5px solid #e7a9ba;
            box-shadow: none;
        }

        .footer {
            text-align: center;
            margin-top: 16px;
            opacity: .8;
        }

        /* ‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .38);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal {
            width: min(460px, 96vw);
            background: #fff;
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            border: 2px solid #E86C8D;
        }

        .modal h3 {
            margin: 6px 0 8px;
        }

        .row {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        .empty {
            text-align: center;
            margin: 16px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üéüÔ∏è</h1>
            <div id="info" class="footer"></div>
        </header>

        <section id="grid" class="grid" aria-live="polite"></section>
        <div id="empty" class="empty hidden">‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üíñ</div>

        <!-- Modal -->
        <div id="backdrop" class="backdrop" role="dialog" aria-modal="true">
            <div class="modal">
                <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£</h3>
                <p id="confirmText">‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°? ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p>
                <div class="row">
                    <button id="confirmBtn" class="btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£</button>
                    <button id="cancelBtn" class="btn ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
        const SUPABASE_URL = 'https://ktieambfqbtduelcwrex.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0aWVhbWJmcWJ0ZHVlbGN3cmV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzMyNzYsImV4cCI6MjA3NzE0OTI3Nn0.tWShEMqOalLANV8aqpQvWx1pGAS8wWLR3DS1AUtr-SQ';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ‡∏î‡∏∂‡∏á order_id ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ---
        const params = new URL(location.href).searchParams;
        const orderId = params.get('id'); // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô UUID/‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏≤‡∏¢‡∏≤‡∏Å
        if (!orderId) {
            document.body.innerHTML = '<p style="font-family:Mali">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ç‡∏≤‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå id)</p>';
            throw new Error('missing order id');
        }
        document.getElementById('info').textContent = `‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ: ${orderId}`;

        // --- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ) ---
        const COUPONS = [
            { id: 'wish-anything-1', title: '‡∏ö‡∏±‡∏ï‡∏£‡∏Ç‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', desc: '‡∏Ç‡∏≠‡πÑ‡∏î‡πâ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢' },
            { id: 'free-day-1', title: '‡∏ö‡∏±‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡πÉ‡∏à 1 ‡∏ß‡∏±‡∏ô', desc: '‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ò‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á' },
            { id: 'shop-1000-1', title: '‡∏ö‡∏±‡∏ï‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ 1,000 ‡∏ö‡∏≤‡∏ó', desc: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÉ‡∏´‡πâ' },
            { id: 'massage-1', title: '‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢ 30 ‡∏ô‡∏≤‡∏ó‡∏µ', desc: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß/‡πÑ‡∏´‡∏•‡πà/‡∏´‡∏•‡∏±‡∏á 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á' },
            { id: 'movie-1', title: '‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô', desc: '‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡πÄ‡∏ò‡∏≠' },
        ];

        const grid = document.getElementById('grid');
        const empty = document.getElementById('empty');
        const backdrop = document.getElementById('backdrop');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        let pendingCouponId = null;

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å DB ---
        async function refresh() {
            const { data, error } = await supabase
                .from('coupon_redemptions')
                .select('coupon_id')
                .eq('order_id', orderId);

            if (error) {
                grid.innerHTML = `<p>‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}</p>`;
                return;
            }
            const used = new Set(data.map(r => r.coupon_id));
            render(COUPONS.filter(c => !used.has(c.id)));
        }

        function render(list) {
            grid.innerHTML = '';
            if (list.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
            }
            list.forEach(c => {
                const el = document.createElement('article');
                el.className = 'card'; el.dataset.id = c.id;
                el.innerHTML = `
          <div class="title">${c.title}</div>
          <div>${c.desc || ''}</div>
          <div><span class="pill">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ</span></div>
          <div class="actions">
            <button class="btn" data-action="redeem">‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ï‡∏£</button>
          </div>
        `;
                el.querySelector('[data-action="redeem"]').onclick = () => openConfirm(c.id, c.title);
                grid.appendChild(el);
            });
        }

        function openConfirm(id, title) {
            pendingCouponId = id;
            document.getElementById('confirmText').textContent =
                `‡∏à‡∏∞‡πÉ‡∏ä‡πâ ‚Äú${title}‚Äù ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°? ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ`;
            backdrop.style.display = 'flex';
        }
        function closeConfirm() { backdrop.style.display = 'none'; pendingCouponId = null; }
        cancelBtn.onclick = closeConfirm;

        confirmBtn.onclick = async () => {
            if (!pendingCouponId) return;
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß (PK ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
            const { error } = await supabase.from('coupon_redemptions').insert({
                order_id: orderId,
                coupon_id: pendingCouponId
            });
            closeConfirm();
            if (error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); return; }
            // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            grid.querySelector(`[data-id="${pendingCouponId}"]`)?.remove();
            if (grid.children.length === 0) empty.classList.remove('hidden');
        };

        // --- ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏Å‡∏î‡πÉ‡∏ä‡πâ ---
        supabase
            .channel('realtime:redemptions')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'coupon_redemptions', filter: `order_id=eq.${orderId}` },
                (payload) => {
                    const cid = payload.new.coupon_id;
                    grid.querySelector(`[data-id="${cid}"]`)?.remove();
                    if (grid.children.length === 0) empty.classList.remove('hidden');
                }
            )
            .subscribe();

        // start
        refresh();
    </script>
</body>

</html>